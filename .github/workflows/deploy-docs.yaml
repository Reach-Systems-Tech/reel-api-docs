name: Deploy Documentation

on:
  repository_dispatch:
    types: [deploy-docs]
  workflow_dispatch:
    inputs:
      version:
        description: "API version (e.g. 1.3.15)"
        required: true
      openapi_url:
        description: "Direct URL to openapi.json (or a tarball URL if you prefer)"
        required: true

permissions:
  contents: write

jobs:
  update-docs:
    # Only run automatically on dispatch; workflow_dispatch is manual testing
    if: github.event_name == 'repository_dispatch' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Resolve inputs
        id: vars
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
            echo "openapi_url=${{ github.event.client_payload.openapi_url }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "openapi_url=${{ inputs.openapi_url }}" >> $GITHUB_OUTPUT
          fi

      - name: Download openapi.json
        shell: bash
        run: |
          VERSION="${{ steps.vars.outputs.version }}"
          OPENAPI_URL="${{ steps.vars.outputs.openapi_url }}"

          mkdir -p "docs/$VERSION"

          # -L to follow redirects (GitHub release download URLs redirect)
          curl -fsSL -L "$OPENAPI_URL" -o "docs/$VERSION/openapi.json"

          python -m json.tool "docs/$VERSION/openapi.json" >/dev/null

      - name: Generate Scalar HTML (version + landing)
        run: |
          python3 .github/scripts/generate_scalar_docs.py \
            --docs-dir docs \
            --version "${{ steps.vars.outputs.version }}" \
            --title "ReelAPI v1"

      - name: Update versions.json
        run: |
          python3 .github/scripts/version_manager.py \
            --docs-dir docs \
            --version "${{ steps.vars.outputs.version }}"

      - name: Commit and push
        shell: bash
        run: |
          VERSION="${{ steps.vars.outputs.version }}"
          git config user.email "action@github.com"
          git config user.name "Documentation Bot"

          git add docs/
          if ! git diff --cached --quiet; then
            git commit -m "Docs: publish Scalar for $VERSION"
            git push
          else
            echo "No changes to commit"
          fi